### Connecting Reviewable to GitHub

To enable Reviewable to integrate with GitHub, you first need to create a new GitHub application.  On https://github.com, find the settings section of your preferred organization&mdash;any one will do.  In the OAuth applications subsection click the Register new application button:
![app registration section](https://raw.githubusercontent.com/Reviewable/Reviewable/master/enterprise/register_github_app.png)
Set the application name, homepage URL, and application description to taste (but preferably not just plain "Reviewable" to avoid confusion).  You can easily update these later so don't sweat it.  Set the authorization callback URL to `https://auth.firebase.com/v2/<REVIEWABLE_FIREBASE>/auth/github/callback`, where `REVIEWABLE_FIREBASE` is the name of your Firebase project, so that GitHub's OAuth service can properly communicate with Firebase's authentication server.

After configuring your GitHub application, head on over to the Login & Auth section in your Firebase App Dashboard. Enable GitHub authentication and then copy your GitHub application credentials (Client ID and Client Secret) into the appropriate inputs. You can find your GitHub application's client ID and secret at the top of the application's GitHub dashboard.  Make sure to whitelist the domain where you'll be hosting Reviewable, and set the session length to at least 3 weeks.

### Runtime expectations

Reviewable is packaged as a Docker image, available from `reviewable/enterprise`, a private repo on Docker Hub&mdash;your docker.com account will be granted pull access when you purchase a license.  To run it you'll need to configure a Docker container.  The entrypoint is already specified in the image but you have to define a bunch of additional environment variables (see below).

We recommend running in a VM with around 1.5GB to 2GB of memory&mdash;less than that and you might run out of memory when handling some big pull requests, and more than that cannot be used by a single Node.js process.  The server is single-threaded, so one vCPU (or even a fraction of one) is sufficient, and the processes are more network than CPU intensive anyway.  On Google Cloud Platform, the `g1-small` instance type is a good fit, on AWS a `t2.small`, and on Azure an `A1`.

You should run at least 2 server instances, fronted by a load-balancing HTTP proxy.  (You can technically run just one and connect to it directly, but such a configuration won't be reliable and won't be able to handle SSL connections.)  The servers are stateless (with the exception of `REVIEWABLE_USER_CONTENT_PATH`, see below) so you can start/stop as many of them as you want without problems.  As of this writing, we don't typically scale up to more than 8 instances for reviewable.io.

The servers expect to be restarted automatically if the process exits.  They'll exit with a non-zero exit code if something went terribly wrong.  You can safely kill a process at any time but it's always preferable to make a clean exit by setting `GAE_VM` (see below) and using `/_ah/stop`.  Doing so will potentially avoid delays on retrying interrupted tasks.

The servers will write logs to `stdout` and `stderr`, with no timestamps.  Some issues will be easier to debug if your environment collects, aggregates, and timestamps those logs.

### Environment variables

Required:
* `REVIEWABLE_LICENSE`: You'll receive a license key when you purchase or renew a license.  This is just a JSON Web Token (JWT), signed with a private key, that encodes the constraints of your license.  It expires at the same time as the license.  The server won't run without a valid and current license key.
* `REVIEWABLE_HOST_URL`: The URL for the Reviewable web server.  HTTP requests sent to this URL must be dispatched to a running Reviewable Docker image at the port below.  The host URL *must be stable* since changing it in any way will break GitHub webhooks and review links.  (Please contact us for help if you absolutely need to change it.)  We recommend that the host URL also be secure (`https://...`) as some requests will contain repository contents, but no credentials or other secrets are ever sent through this address. 
* `PORT`: The port for the web server to listen on.  Reviewable assumes that a higher layer will provide load balancing and SSL termination, and forward requests to the servers over HTTP on an internal, secure network.  Defaults to port 8080, which is also exposed in the Docker container.
* `REVIEWABLE_FIREBASE`: The name of the Firebase project you'll be using to store Reviewable data.  If we're managing your Firebase instance then your Google account will be granted access to it when you purchase a license.
* `REVIEWABLE_FIREBASE_AUTH`: A master secret for the Firebase project above, obtained from the Secrets tab on the Firebase management page.  Can be rotated as necessary (e.g, if compromised).

Optional:
* `REVIEWABLE_ENCRYPTION_PRIVATE_KEYS`: A comma-separated list of unencrypted RSA private keys in PEM format, optionally with newlines removed.  These keys will be used to encrypt especially sensitive data in the Firebase datastore to provide an extra line of defense in case of a breach.  Currently, this includes all GitHub authorization tokens.  The current key should be first in the list, and any number of additional keys can be listed afterwards to assist with key rotation.
* `REVIEWABLE_GITHUB_SECRET_TOKEN`: An arbitrary secret string that will be used to sign GitHub webhook requests to ensure their authenticity.  Set to anything random, robust when transmitted as text, and reasonably long (e.g., 64 hex characters).  Once set don't ever change it, or you'll invalidate the hooks on all connected repos.
* `REVIEWABLE_SMTP_URL`: The URL of an SMTP server to use when sending administrative emails.  (Review notifications are sent via GitHub.)  Use the format `smtp://username:password@smtp.example.com:port/`.  The connection will be automatically secured if the server supports it, but you can append `?requireTLS=true` if you want to force `STARTTLS`, or use `https` for a direct TLS connection on port 465.  If missing, Reviewable will attempt to send emails by connecting directly to the recipient's MX server, but this is not very reliable (no retries, no DKIM/SPF so messages likely to be treated as spam).
* `REVIEWABLE_SMTP_FROM`: The `From` email address to set on outgoing messages.  Can be either a plain email address or the full `"Sender Name" <sender@example.com>` syntax.  If missing, Reviewable will default to `Reviewable <support@reviewable.io>`.
* `REVIEWABLE_SMTP_BCC`: A `Bcc` email address to copy each message to, useful for keeping an eye on the emails that Reviewable is sending.  If missing, no copies are sent.
* `REVIEWABLE_USER_CONTENT_PATH`: An absolute path to a directory on a shared persistent volume that will be used to store comment attachments.  The file types and sizes will be checked by Reviewable; as of this writing, only images up to 10MB in size are allowed.  If missing, users won't be able to attach files to comments.
* `REVIEWABLE_PING_URL`: A URL that each server will ping with a GET request at 1 minute intervals as long as (it thinks) it's healthy.  You can connect this to some external health-monitoring system that can alert you if all servers are unhealthy.
* `REVIEWABLE_TERMS_URL`: The URL for the Terms link in the footer of every Reviewable page.  If missing, the link won't be shown in the footer.
* `REVIEWABLE_PRIVACY_URL`: The URL for the Privacy link in the footer of every Reviewable page.  If missing, the link won't be shown in the footer.
* `GAE_MODULE_INSTANCE`: The zero-based, consecutive instance number of the current process.  If set, some servers will specialize themselves to optimize latency for user-facing operations.
* `GAE_VM`: If set (to any value), the servers will handle requests to `/_ah/health`, `/_ah/start`, and `/_ah/stop`, per the [standard GAE semantics](https://cloud.google.com/appengine/docs/flexible/custom-runtimes/build#lifecycle_events).  It's up to you to restrict requests to those endpoints so random people can't shut down your servers.  The servers will also trust the proxy that's immediately in front of them.
* `MEMORY_AVAILABLE`: The amount of memory available to the Node process in MiB.  Defaults to the lower of `/proc/meminfo` `MemTotal` and `/sys/fs/cgroup/memory/memory.stat` `hierarchical_memory_limit`.  If not set accurately, the servers are more likely to run out of memory and start swapping.  A server logs how much memory it thinks it has available when it starts up.
